# Python Code Generator (pygen)

Python Code Generator for SnapSQL - generates Python database query code from intermediate format.

## Overview

The `pygen` package is a Go-based code generator that produces Python code from SnapSQL's intermediate format. It follows the same architecture as the existing Go generator (`gogen`) but outputs Python code with async/await support and type hints.

## Architecture

- **Implementation Language**: Go
- **Output Language**: Python 3.9+
- **Template Engine**: Go text/template
- **Pattern**: Follows gogen architecture

## Features

### Supported Dialects

- **PostgreSQL**: Using `asyncpg` driver
- **MySQL**: Using `aiomysql` driver  
- **SQLite**: Using `aiosqlite` driver

### Python Features

- **Type Hints**: Full PEP 484 type annotations
- **Dataclasses**: PEP 557 dataclasses for response structures
- **Async/Await**: All generated functions are async
- **Context Variables**: Using `contextvars` for request-scoped data

## Usage

### Basic Usage

```go
package main

import (
    "os"
    "github.com/shibukawa/snapsql/intermediate"
    "github.com/shibukawa/snapsql/langs/pygen"
)

func main() {
    // Load intermediate format
    format := &intermediate.IntermediateFormat{
        FunctionName: "get_user_by_id",
        // ... other fields
    }

    // Create generator
    gen := pygen.New(
        format,
        pygen.WithDialect("postgres"),
        pygen.WithPackageName("queries"),
    )

    // Generate code
    file, _ := os.Create("queries.py")
    defer file.Close()
    
    gen.Generate(file)
}
```

### Using Configuration

```go
config := pygen.Config{
    PackageName: "queries",
    OutputPath:  "./generated",
    Dialect:     "postgres",
    MockPath:    "./testdata/mocks",
    Features: pygen.FeatureConfig{
        EnableQueryLogging: true,
        PreserveHierarchy:  true,
    },
}

gen, err := pygen.NewGeneratorFromConfig(format, config)
if err != nil {
    log.Fatal(err)
}

gen.Generate(writer)
```

## Configuration Options

### Generator Options

- `WithPackageName(name)`: Set Python module name (default: "generated")
- `WithDialect(dialect)`: Set database dialect (required: postgres, mysql, sqlite)
- `WithOutputPath(path)`: Set output directory path
- `WithMockPath(path)`: Set mock data path for testing

### Feature Flags

- `EnableQueryLogging`: Enable query logging functionality
- `EnableCaching`: Enable query result caching
- `EnableRetry`: Enable retry logic with exponential backoff
- `PreserveHierarchy`: Enable hierarchical response structures

## Generated Code Structure

```python
# Generated by snapsql - DO NOT EDIT
from typing import Optional, List, Any, Dict, AsyncGenerator
from dataclasses import dataclass, asdict
from datetime import datetime
from decimal import Decimal
import contextvars

# Database driver imports (dialect-specific)
import asyncpg  # for postgres

# Response structures
@dataclass
class GetUserByIdResult:
    user_id: int
    username: str
    email: Optional[str] = None
    
    def to_dict(self) -> Dict[str, Any]:
        return asdict(self)

# Generated function
async def get_user_by_id(
    conn: asyncpg.Connection,
    user_id: int
) -> GetUserByIdResult:
    """Get user by ID"""
    # ... implementation
```

## Development Status

### Task 1: Project Structure and Core Implementation âœ…

- [x] Go package structure setup (langs/pygen/)
- [x] Basic Generator struct with option pattern
- [x] Configuration management (Config struct)
- [x] Error definitions
- [x] Unit tests

### Upcoming Tasks

- [ ] Task 2: Type conversion system
- [ ] Task 3: Python template creation
- [ ] Task 4: Parameter processing
- [ ] Task 5: Response structure generation
- [ ] And more...

## Testing

Run tests:

```bash
go test ./langs/pygen/...
```

Run with coverage:

```bash
go test -cover ./langs/pygen/...
```

## Requirements

This generator implements requirements from the Python Code Generator specification:

- **Requirement 1.1**: Generate valid Python code from intermediate format
- **Requirement 10.1**: Support package name configuration
- **Requirement 10.2**: Support output path configuration
- **Requirement 10.3**: Support mock data path configuration
- **Requirement 10.4**: Support dialect configuration
- **Requirement 10.5**: Support hierarchy preservation configuration

## Design Decisions

### Why Go Implementation?

- Shares codebase and patterns with gogen
- Reuses intermediate format processing logic
- Integrates easily with SnapSQL build process
- Type safety and performance
- Powerful text/template functionality

### Why Async-Only?

- Modern Python best practice (3.7+)
- Natural integration with asyncio
- Better performance for I/O operations
- Simpler implementation (no sync/async variants)

### Why contextvars?

- Automatic context isolation between async tasks
- Perfect for request-scoped data
- Native asyncio integration
- Safer than global variables

## Related Packages

- `langs/gogen`: Go code generator (reference implementation)
- `langs/snapsqlgo`: Go runtime support library
- `intermediate`: Intermediate format definitions

## License

Apache License 2.0
