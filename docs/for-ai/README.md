# SnapSQL for AI Agents

This directory contains comprehensive documentation for AI agents working with SnapSQL, a SQL template engine that enables dynamic SQL generation using the **2-way SQL format**.

## Quick Overview

SnapSQL allows you to write SQL templates that work as standard SQL during development while providing runtime flexibility for dynamic query construction. Templates are processed to generate type-safe code and can be tested with mock data.

## Key Concepts

- **2-way SQL Format**: Templates work as valid SQL when comments are removed
- **Dynamic Query Building**: Add WHERE clauses, ORDER BY, and SELECT fields at runtime
- **System Columns**: Automatic handling of common database fields (created_at, updated_at, etc.)
- **Type Safety**: Generated code provides compile-time type checking
- **Mock Testing**: Test templates without database dependencies

## Document Structure

| Document | Purpose |
|----------|---------|
| [Template Formats](./template-formats.md) | SQL and Markdown template formats |
| [Directives Reference](./directives.md) | Complete directive syntax guide |
| [System Columns](./system-columns.md) | Automatic system column handling |
| [Output Customization](./output-customization.md) | AS/CAST and type control |
| [Testing Guide](./testing.md) | Mock data and test case creation |
| [Code Generation](./code-generation.md) | Generated code structure and usage |
| [Best Practices](./best-practices.md) | Patterns and recommendations |
| [Examples](./examples.md) | Common use cases and patterns |

## Quick Start Example

### Markdown Template (.snap.md) - **Recommended**
````markdown
---
function_name: get_project_users
---

# Get Project User List

## Description
Get project user list with department information.

## Parameters
```yaml
project_id: int
include_profile: bool
page_size: int
page: int
```

## SQL
```sql
SELECT 
    u.id, 
    u.name,
    /*# if include_profile */
        p.bio,
        p.avatar_url,
    /*# end */
    d.id as departments__id,
    d.name as departments__name
FROM users AS u
    JOIN departments AS d ON u.department_id = d.id
    /*# if include_profile */
        LEFT JOIN profiles AS p ON u.id = p.user_id
    /*# end */
WHERE u.project_id = /*= project_id */1
LIMIT /*= page_size != 0 ? page_size : 10 */10
OFFSET /*= page > 0 ? (page - 1) * page_size : 0 */0;
```

## Test Cases
### Test: Basic user list
**Parameters:**
```yaml
project_id: 1
include_profile: false
page_size: 10
page: 1
```

**Expected Results:**
```yaml
- {id: 1, name: "John Doe", departments__id: 1, departments__name: "Engineering"}
```
````

### SQL Template (.snap.sql) - **For Migration**
```sql
/*#
function_name: get_user_list
description: Get user list with optional filtering
parameters:
  include_email: bool
  active_only: bool
  limit: int
response_affinity: many
*/
SELECT 
    id,
    name,
    /*# if include_email */
    email,
    /*# end */
    created_at
FROM users
WHERE 1=1
    /*# if active_only */
    AND active = /*= active_only */true
    /*# end */
ORDER BY created_at DESC
LIMIT /*= limit */10;
```

## Generated Code Usage

```go
// Generated type-safe function
func GetProjectUsers(ctx context.Context, db *sql.DB, 
    projectId int, includeProfile bool, pageSize int, page int) iter.Seq2[User, error] {
    // Implementation generated by SnapSQL
}

// Usage in application
for user, err := range GetProjectUsers(ctx, db, 10, false, 20, 1) {
    if err != nil {
        log.Fatal(err)
    }
    fmt.Printf("User: %s (%s)\n", user.Name, user.Departments[0].Name)
}
```

## CLI Commands

```bash
# Generate code from templates
snapsql generate -i ./queries --lang go

# Test templates with mock data
snapsql query template.snap.md --dry-run --params-file params.json

# Validate templates
snapsql validate ./queries
```

## Next Steps

1. Read [Template Formats](./template-formats.md) to understand the two template formats
2. Study [Directives Reference](./directives.md) for complete syntax
3. Learn [Output Customization](./output-customization.md) for type control
4. Check [Examples](./examples.md) for common patterns
