# ジェネレータプラグインシステム設計

## 概要

SnapSQLは外部ジェネレータプラグインを通じて拡張可能なコード生成をサポートします。これにより、ユーザーは簡単なコマンドラインインターフェースを実装することで、任意のプログラミング言語や出力形式のサポートを追加できます。

## アーキテクチャ

### プラグイン発見

SnapSQLは以下の命名パターンの実行可能ファイルを探してジェネレータプラグインを発見します：
```
snapsql-gen-<言語名>
```

例：
- `snapsql-gen-go` - Go言語ジェネレータ
- `snapsql-gen-java` - Java言語ジェネレータ  
- `snapsql-gen-python` - Python言語ジェネレータ
- `snapsql-gen-typescript` - TypeScript言語ジェネレータ
- `snapsql-gen-rust` - Rust言語ジェネレータ（カスタム）
- `snapsql-gen-csharp` - C#言語ジェネレータ（カスタム）

### プラグイン実行

`snapsql generate --lang <言語名>`が実行されると、SnapSQLは：

1. システムPATHから対応する`snapsql-gen-<言語名>`実行可能ファイルを探す
2. SQLテンプレートを解析して中間JSON形式を生成する
3. 中間データと設定でジェネレータプラグインを呼び出す
4. プラグインが対象言語のコードを生成する

### コマンドラインインターフェース

ジェネレータプラグインは以下のコマンドラインインターフェースを実装する必要があります：

```bash
snapsql-gen-<言語名> [オプション] <中間JSONファイル>
```

#### 必須引数

- `<中間JSONファイル>` - 解析されたSQLテンプレートを含む中間JSONファイルのパス

#### 標準オプション

- `--output-dir <パス>` - 生成ファイルの出力ディレクトリ
- `--package <名前>` - 生成コードのパッケージ/名前空間名
- `--schema-file <パス>` - データベーススキーマファイル（schema.yaml）のパス
- `--constants <ファイル1,ファイル2,...>` - 定数定義ファイルのカンマ区切りリスト
- `--config <ファイル>` - SnapSQL設定ファイルのパス
- `--verbose` - 詳細出力を有効にする
- `--help` - ヘルプ情報を表示

#### 実行例

```bash
snapsql-gen-go \
  --output-dir ./internal/queries \
  --package queries \
  --schema-file ./schema.yaml \
  --constants ./constants/database.yaml,./constants/tables.yaml \
  --config ./snapsql.yaml \
  --verbose \
  intermediate.json
```

### 入力データ形式

#### 中間JSON構造

中間JSONファイルには解析されたSQLテンプレート情報が含まれます：

```json
{
  "templates": [
    {
      "file": "queries/users.snap.sql",
      "name": "users",
      "ast": {
        "type": "SELECT_STATEMENT",
        "selectClause": {...},
        "fromClause": {...},
        "whereClause": {...}
      },
      "parameters": {
        "user_id": "int",
        "filters": {
          "active": "bool",
          "departments": ["str"]
        },
        "pagination": {
          "limit": "int",
          "offset": "int"
        }
      },
      "metadata": {
        "has_dynamic_where": true,
        "has_dynamic_select": false,
        "has_dynamic_order": true,
        "estimated_complexity": "medium"
      }
    }
  ],
  "global_constants": {
    "tables": {
      "users": "users_v2",
      "posts": "posts_archive"
    },
    "environments": {
      "dev": "dev_",
      "prod": "prod_"
    }
  },
  "generation_config": {
    "dialect": "postgres",
    "package": "queries",
    "output_dir": "./internal/queries"
  }
}
```

#### スキーマファイル形式（オプション）

`--schema-file`が提供される場合、データベーススキーマ情報が含まれます：

```yaml
database:
  name: "myapp_db"
  dialect: "postgres"
  version: "14.5"

schemas:
  public:
    tables:
      users:
        columns:
          id:
            type: "bigint"
            nullable: false
            primary_key: true
          name:
            type: "varchar"
            length: 255
            nullable: false
        indexes:
          users_email_idx:
            columns: ["email"]
            unique: true
```

#### 定数ファイル形式

定数定義ファイルはYAML形式です：

```yaml
# constants/database.yaml
tables:
  users: "users_v2"
  posts: "posts_archive"

environments:
  dev: "dev_"
  prod: "prod_"
```

### 出力要件

#### ファイル生成

ジェネレータプラグインは以下を行う必要があります：

1. 指定された`--output-dir`に出力ファイルを作成
2. SQLテンプレートに基づいて型安全な関数を生成
3. 適切なインポートとパッケージ宣言を含める
4. パラメータ検証と型変換を処理

#### 標準出力/エラー出力

- **標準出力**: 進行状況情報、生成ファイルリスト、その他の情報メッセージに使用可能
- **標準エラー出力**: エラーメッセージ、警告、デバッグ情報に使用
- **終了コード**:
  - `0` - 成功
  - `1` - 一般的なエラー
  - `2` - 無効な引数
  - `3` - ファイルI/Oエラー
  - `4` - コード生成エラー

#### 出力例（Goジェネレータ）

```go
// Generated by snapsql-gen-go
package queries

import (
    "context"
    "database/sql"
)

// UsersParams represents parameters for the users query
type UsersParams struct {
    UserID     int                 `json:"user_id"`
    Filters    UsersFilters        `json:"filters"`
    Pagination UsersPagination     `json:"pagination"`
}

type UsersFilters struct {
    Active      bool     `json:"active"`
    Departments []string `json:"departments"`
}

type UsersPagination struct {
    Limit  int `json:"limit"`
    Offset int `json:"offset"`
}

// Users executes the users query
func Users(ctx context.Context, db *sql.DB, params UsersParams) (*sql.Rows, error) {
    query, args := buildUsersQuery(params)
    return db.QueryContext(ctx, query, args...)
}

func buildUsersQuery(params UsersParams) (string, []any) {
    // Generated query building logic
    // ...
}
```

### プラグイン開発ガイドライン

#### 言語固有の考慮事項

1. **Go**: 適切なエラーハンドリングを含む慣用的なGoコードを生成
2. **Java**: 適切なJava命名規則と型システムを使用
3. **Python**: PEP 8スタイルガイドラインに従い、型ヒントを使用
4. **TypeScript**: 適切なTypeScriptインターフェースと型を生成
5. **カスタム言語**: その言語の確立された規約に従う

#### ベストプラクティス

1. **型安全性**: 強く型付けされたパラメータ構造を生成
2. **エラーハンドリング**: 生成コードに適切なエラーハンドリングを含める
3. **ドキュメント**: コードコメントとドキュメントを生成
4. **テスト**: テストヘルパーやモック関数の生成を検討
5. **パフォーマンス**: ランタイムパフォーマンスのために生成コードを最適化

#### プラグインテスト

ジェネレータプラグインには以下を含める必要があります：

1. ジェネレータロジックの単体テスト
2. サンプル中間JSONとの統合テスト
3. 出力検証テスト
4. 大きなテンプレートのパフォーマンスベンチマーク

### 組み込みジェネレータ

SnapSQLには一般的な言語用の組み込みジェネレータが含まれます：

- `json` - JSON中間形式（内蔵）
- `go` - Go言語ジェネレータ（内蔵）
- `typescript` - TypeScriptジェネレータ（内蔵）
- `java` - Javaジェネレータ（内蔵）
- `python` - Pythonジェネレータ（内蔵）

これらのジェネレータはメインの`snapsql`バイナリにコンパイルされており、外部実行可能ファイルは不要です。

### 拡張ポイント

#### カスタムジェネレータ

ユーザーは以下によってカスタムジェネレータを作成できます：

1. コマンドラインインターフェース仕様の実装
2. システムPATHへの実行可能ファイルの配置
3. `snapsql-gen-<言語名>`命名規則の遵守

#### ジェネレータ設定

ジェネレータは以下から追加設定を読み取ることができます：

1. メインSnapSQL設定ファイル（`snapsql.yaml`）
2. 言語固有の設定セクション
3. 環境変数
4. コマンドライン引数

### エラーハンドリング

#### プラグインが見つからない場合

要求されたジェネレータプラグインが見つからない場合：

```bash
$ snapsql generate --lang rust
Error: Generator plugin 'snapsql-gen-rust' not found in PATH
```

#### プラグイン実行エラー

ジェネレータプラグインが失敗した場合：

```bash
$ snapsql generate --lang go
Error: Generator plugin 'snapsql-gen-go' failed with exit code 1
Plugin stderr: Invalid parameter type in template users.snap.sql
```
