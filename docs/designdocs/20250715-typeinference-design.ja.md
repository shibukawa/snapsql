# SnapSQL型推論システム設計

## 概要

SnapSQLの型推論システムは、SQL文の各フィールドの型情報を自動的に推論し、データベーススキーマ情報と統合して正確な型安全性を提供するシステムです。SELECT文、INSERT/UPDATE/DELETE文の両方をサポートし、サブクエリやCTE（Common Table Expression）などの複雑なSQL構造にも対応しています。

## 設計原則

### 1. スキーマ統合アプローチ
- データベーススキーマ情報（pullパッケージ経由）を基盤とした型推論
- PostgreSQL、MySQL、SQLite等の複数データベース方言対応
- 実際のテーブル・カラム定義からの正確な型情報取得

### 2. 段階的型推論プロセス
- スキーマ検証、基本型推論、高度な式解析の段階的処理
- エラーハンドリングと修正提案機能の統合
- パフォーマンスを考慮したキャッシュ機能

### 3. 拡張可能なアーキテクチャ
- モジュラー設計による機能拡張の容易性
- 新しいSQL構文や関数への対応が可能な設計
- テスト容易性を重視したコンポーネント分離

## システムアーキテクチャ

### コアコンポーネント

#### TypeInferenceEngine2
型推論の中核エンジンとして、以下の責務を持ちます：
- SQL文の種類判定（SELECT、INSERT/UPDATE/DELETE）
- 各フィールドの型推論処理の統括
- サブクエリ情報との統合
- 結果のフィールド情報生成

#### SchemaResolver
データベーススキーマ情報の解決を担当：
- pullパッケージで取得したスキーマ情報の活用
- テーブル・カラムの存在確認と型情報取得
- テーブルエイリアスの解決
- 複数テーブル間でのカラム検索

#### SchemaValidator
スキーマの妥当性検証を実行：
- テーブル参照の検証
- カラム参照の検証
- 曖昧なカラム参照の検出
- エラー修正提案（編集距離ベース）

#### DMLInferenceEngine
DML文（INSERT/UPDATE/DELETE）専用の型推論エンジン：
- INSERT文の型推論（VALUES句、SELECT句）
- UPDATE文のSET句型推論
- DELETE文の型推論
- RETURNING句の処理（SELECT推論の再利用）

#### SubqueryTypeResolver
サブクエリとCTEの型推論を担当：
- WITH句（CTE）の型情報解決
- FROM句サブクエリの型推論
- SELECT句サブクエリの型推論
- サブクエリ間の依存関係管理

#### FieldNameGenerator & EnhancedFieldNameGenerator
フィールド名の自動生成機能：
- 基本的なフィールド名生成と重複回避
- 複雑な式での意味的フィールド名生成
- 算術演算、CASE式、CAST式等の可読性向上

## 型推論処理フロー

### 1. 初期化と準備
- データベーススキーマ情報の読み込み
- SQL文のパースとAST構造の取得
- サブクエリ解析情報の取得（parserstep7経由）
- 推論コンテキストの初期化

### 2. スキーマ検証
- 参照されるテーブルの存在確認
- カラム参照の妥当性検証
- テーブルエイリアスの解決
- エラー検出と修正提案の生成

### 3. サブクエリ型推論
- CTEの依存関係解析
- サブクエリの型情報解決
- サブクエリ結果のテーブル化
- 利用可能なサブクエリテーブル情報の更新

### 4. フィールド別型推論
各フィールドの種類に応じた専用処理：

#### テーブルフィールド
- テーブル.カラム形式の参照解決
- スキーマ情報からの型情報取得
- サブクエリテーブルとの優先順位判定

#### 単一フィールド
- 非修飾カラム名の解決
- 複数テーブル間での曖昧性検出
- 最適なテーブル候補の選択

#### 関数フィールド
- 関数名による型推論ルール適用
- 引数の型解析とCAST追跡
- 戻り値型の決定

#### リテラルフィールド
- リテラル値の型判定
- 数値、文字列、日付等の型分類
- NULL許可状況の判定

#### 複雑フィールド
- 算術演算子の型昇格ルール適用
- CASE式の分岐型統合
- CAST式の明示的型変換処理
- JSON演算子の型推論

### 5. DML文特化処理
INSERT/UPDATE/DELETE文では追加処理：
- 対象テーブルの特定
- SET句やVALUES句の型推論
- RETURNING句の処理（SELECT推論再利用）
- 影響行数情報の生成

### 6. フィールド名生成
- 明示的エイリアスの使用
- 自動フィールド名生成
- 重複名の回避処理
- 複雑式での意味的命名

### 7. 結果統合
- 推論結果のフィールド情報構築
- 型情報、NULL許可、ソース情報の統合
- エラー情報と警告の収集
- 最終結果の返却

## 型推論ルール

### 基本型マッピング
データベース型からSnapSQL統一型への変換：
- 数値型：INTEGER、DECIMAL、FLOAT等
- 文字型：TEXT、VARCHAR等
- 日時型：DATE、TIME、TIMESTAMP等
- その他：BOOLEAN、JSON、BINARY等

### 関数型推論
関数名と引数に基づく戻り値型の決定：
- 集約関数：COUNT→INTEGER、SUM→数値型継承
- 文字列関数：LENGTH→INTEGER、SUBSTRING→TEXT
- 日時関数：NOW→TIMESTAMP、DATE→DATE
- 数学関数：ABS→引数型継承、ROUND→DECIMAL

### 演算子型推論
演算子の種類に応じた結果型の決定：
- 算術演算：型昇格ルール適用（INTEGER+DECIMAL→DECIMAL）
- 比較演算：常にBOOLEAN
- 論理演算：常にBOOLEAN
- 文字列結合：TEXT

### 型昇格システム
異なる型同士の演算での型決定：
- 数値型階層：INTEGER < DECIMAL < FLOAT
- 文字列統合：すべてTEXT
- 日時型保持：DATE/TIME/TIMESTAMP型の維持

## エラーハンドリング

### 検証エラー
- テーブル未発見エラー
- カラム未発見エラー
- 曖昧なカラム参照エラー
- 型不適合エラー

### 修正提案
- 編集距離アルゴリズムによる類似名提案
- 利用可能なテーブル・カラム一覧表示
- エイリアス修正提案

### エラーレベル
- 警告：継続可能な問題
- エラー：処理停止が必要な問題

## パフォーマンス最適化

### キャッシュ戦略
- 型推論結果のキャッシュ
- スキーマ情報のインデックス化
- サブクエリ型情報の保存

### 処理最適化
- 段階的処理による早期終了
- 並列処理可能な部分の特定
- メモリ効率的なデータ構造

## 拡張性

### 新機能追加
- 新しいSQL構文への対応
- 新しいデータベース方言のサポート
- カスタム関数の型推論ルール追加

### モジュール拡張
- 専用型推論エンジンの追加
- カスタムフィールド名生成器の実装
- 新しい検証ルールの追加

## 今後の発展

### 高度な型推論
- ユーザー定義型の対応
- 複雑なサブクエリパターンの最適化
- 動的型推論の実装

### 統合機能
- 中間形式出力との連携
- コード生成機能との統合
- IDE拡張機能のサポート

この型推論システムは、SnapSQLの核心機能として、正確で効率的な型情報提供を通じて、開発者の生産性向上とコードの品質向上に寄与します。
