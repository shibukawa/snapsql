# Generator Plugin System Design

## Overview

SnapSQL supports extensible code generation through external generator plugins. This allows users to add support for any programming language or output format by implementing a simple command-line interface.

## Architecture

### Plugin Discovery

SnapSQL discovers generator plugins by looking for executables with the naming pattern:
```
snapsql-gen-<language>
```

Examples:
- `snapsql-gen-go` - Go language generator
- `snapsql-gen-java` - Java language generator  
- `snapsql-gen-python` - Python language generator
- `snapsql-gen-typescript` - TypeScript language generator
- `snapsql-gen-rust` - Rust language generator (custom)
- `snapsql-gen-csharp` - C# language generator (custom)

### Plugin Execution

When `snapsql generate --lang <language>` is executed, SnapSQL:

1. Looks for the corresponding `snapsql-gen-<language>` executable in the system PATH
2. Parses SQL templates and generates intermediate JSON format
3. Invokes the generator plugin with the intermediate data and configuration
4. The plugin generates the target language code

### Command Line Interface

Generator plugins must implement the following command-line interface:

```bash
snapsql-gen-<lang> [options] <intermediate-json-file>
```

#### Required Arguments

- `<intermediate-json-file>` - Path to the intermediate JSON file containing parsed SQL templates

#### Standard Options

- `--output-dir <path>` - Output directory for generated files
- `--package <name>` - Package/namespace name for generated code
- `--schema-file <path>` - Path to database schema file (schema.yaml)
- `--constants <file1,file2,...>` - Comma-separated list of constant definition files
- `--config <file>` - Path to SnapSQL configuration file
- `--verbose` - Enable verbose output
- `--help` - Show help information

#### Example Invocation

```bash
snapsql-gen-go \
  --output-dir ./internal/queries \
  --package queries \
  --schema-file ./schema.yaml \
  --constants ./constants/database.yaml,./constants/tables.yaml \
  --config ./snapsql.yaml \
  --verbose \
  intermediate.json
```

### Input Data Format

#### Intermediate JSON Structure

The intermediate JSON file contains parsed SQL template information:

```json
{
  "templates": [
    {
      "file": "queries/users.snap.sql",
      "name": "users",
      "ast": {
        "type": "SELECT_STATEMENT",
        "selectClause": {...},
        "fromClause": {...},
        "whereClause": {...}
      },
      "parameters": {
        "user_id": "int",
        "filters": {
          "active": "bool",
          "departments": ["str"]
        },
        "pagination": {
          "limit": "int",
          "offset": "int"
        }
      },
      "metadata": {
        "has_dynamic_where": true,
        "has_dynamic_select": false,
        "has_dynamic_order": true,
        "estimated_complexity": "medium"
      }
    }
  ],
  "global_constants": {
    "tables": {
      "users": "users_v2",
      "posts": "posts_archive"
    },
    "environments": {
      "dev": "dev_",
      "prod": "prod_"
    }
  },
  "generation_config": {
    "dialect": "postgres",
    "package": "queries",
    "output_dir": "./internal/queries"
  }
}
```

#### Schema File Format (Optional)

If `--schema-file` is provided, it contains database schema information:

```yaml
database:
  name: "myapp_db"
  dialect: "postgres"
  version: "14.5"

schemas:
  public:
    tables:
      users:
        columns:
          id:
            type: "bigint"
            nullable: false
            primary_key: true
          name:
            type: "varchar"
            length: 255
            nullable: false
        indexes:
          users_email_idx:
            columns: ["email"]
            unique: true
```

#### Constant Files Format

Constant definition files are in YAML format:

```yaml
# constants/database.yaml
tables:
  users: "users_v2"
  posts: "posts_archive"

environments:
  dev: "dev_"
  prod: "prod_"
```

### Output Requirements

#### File Generation

Generator plugins should:

1. Create output files in the specified `--output-dir`
2. Generate type-safe functions based on SQL templates
3. Include proper imports and package declarations
4. Handle parameter validation and type conversion

#### Standard Output/Error

- **Standard Output**: Can be used for progress information, generated file lists, or other informational messages
- **Standard Error**: Should be used for error messages, warnings, and debugging information
- **Exit Codes**:
  - `0` - Success
  - `1` - General error
  - `2` - Invalid arguments
  - `3` - File I/O error
  - `4` - Code generation error

#### Example Output (Go Generator)

```go
// Generated by snapsql-gen-go
package queries

import (
    "context"
    "database/sql"
)

// UsersParams represents parameters for the users query
type UsersParams struct {
    UserID     int                 `json:"user_id"`
    Filters    UsersFilters        `json:"filters"`
    Pagination UsersPagination     `json:"pagination"`
}

type UsersFilters struct {
    Active      bool     `json:"active"`
    Departments []string `json:"departments"`
}

type UsersPagination struct {
    Limit  int `json:"limit"`
    Offset int `json:"offset"`
}

// Users executes the users query
func Users(ctx context.Context, db *sql.DB, params UsersParams) (*sql.Rows, error) {
    query, args := buildUsersQuery(params)
    return db.QueryContext(ctx, query, args...)
}

func buildUsersQuery(params UsersParams) (string, []interface{}) {
    // Generated query building logic
    // ...
}
```

### Plugin Development Guidelines

#### Language-Specific Considerations

1. **Go**: Generate idiomatic Go code with proper error handling
2. **Java**: Use appropriate Java naming conventions and type systems
3. **Python**: Follow PEP 8 style guidelines and use type hints
4. **TypeScript**: Generate proper TypeScript interfaces and types
5. **Custom Languages**: Follow the language's established conventions

#### Best Practices

1. **Type Safety**: Generate strongly-typed parameter structures
2. **Error Handling**: Include proper error handling in generated code
3. **Documentation**: Generate code comments and documentation
4. **Testing**: Consider generating test helpers or mock functions
5. **Performance**: Optimize generated code for runtime performance

#### Plugin Testing

Generator plugins should include:

1. Unit tests for the generator logic
2. Integration tests with sample intermediate JSON
3. Output validation tests
4. Performance benchmarks for large templates

### Built-in Generators

SnapSQL includes built-in generators for common languages:

- `json` - JSON intermediate format (internal)
- `go` - Go language generator (internal)
- `typescript` - TypeScript generator (internal)
- `java` - Java generator (internal)
- `python` - Python generator (internal)

These generators are compiled into the main `snapsql` binary and do not require external executables.

### Extension Points

#### Custom Generators

Users can create custom generators by:

1. Implementing the command-line interface specification
2. Placing the executable in the system PATH
3. Following the naming convention `snapsql-gen-<language>`

#### Generator Configuration

Generators can read additional configuration from:

1. The main SnapSQL configuration file (`snapsql.yaml`)
2. Language-specific configuration sections
3. Environment variables
4. Command-line arguments

### Error Handling

#### Plugin Not Found

If a requested generator plugin is not found:

```bash
$ snapsql generate --lang rust
Error: Generator plugin 'snapsql-gen-rust' not found in PATH
```

#### Plugin Execution Errors

If a generator plugin fails:

```bash
$ snapsql generate --lang go
Error: Generator plugin 'snapsql-gen-go' failed with exit code 1
Plugin stderr: Invalid parameter type in template users.snap.sql
```
