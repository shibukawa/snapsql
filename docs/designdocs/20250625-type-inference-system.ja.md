# SELECT句フィールドの型推論システム

## 概要

本ドキュメントは、SELECT句の各フィールドの型をデータベーススキーマ情報に基づいて推論する型推論システムの設計について説明します。このシステムは、コード生成やランタイムでの型安全性のために正確な型情報を提供します。

## 課題

SQLテンプレートからコードを生成する際、SELECT句の各フィールドの正確なデータ型を知る必要があります。

1. ターゲット言語での強い型付けデータ構造の生成
2. IDEサポートやIntelliSenseのための型情報提供
3. コンパイル時の型チェック
4. 適切なシリアライズ/デシリアライズコードの生成
5. パラメータ型とカラム型の検証

## 要件

### 機能要件

1. **カラム型解決**: 直接的なカラム参照（`table.column`, `column`）の型解決
2. **式の型推論**: 式・関数・計算の型推論
3. **エイリアス対応**: カラムエイリアスを通した型情報の追跡
4. **JOIN対応**: JOIN時の複数テーブル横断型解決
5. **集約関数対応**: 集約関数の返却型判定
6. **組み込み関数対応**: 一般的なSQL関数の返却型対応
7. **サブクエリ対応**: サブクエリやCTEの型推論
8. **CASE式対応**: 条件式の型推論
9. **マルチDB対応**: PostgreSQL, MySQL, SQLiteの型体系対応

### 非機能要件

1. **パフォーマンス**: 大規模スキーマでも高速な型解決
2. **精度**: 高精度な型推論と低い誤判定率
3. **拡張性**: 新関数・新型追加の容易さ
4. **エラー処理**: 解決不能な型に対する明確なエラーメッセージ

## アーキテクチャ

### コアコンポーネント

```
┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│   スキーマストア │    │ 型リゾルバ      │    │ 関数レジストリ   │
│                 │    │                 │    │                 │
│ - テーブル情報   │◄───┤ - カラム型      │◄───┤ - 組込関数      │
│ - カラム型       │    │ - 式解析        │    │ - 集約関数      │
│ - 制約           │    │ - 型ルール      │    │ - キャストルール│
└───────────────┘    │                 │    └───────────────┘
                      └───────────────┘
                               │
                               ▼
                      ┌───────────────┐
                      │ 型推論エンジン │
                      │               │
                      │ - ASTウォーク │
                      │ - コンテキスト│
                      │ - エラーハンドラ│
                      └───────────────┘
```

### データ構造

#### スキーマ情報
```go
type SchemaStore struct {
    Tables    map[string]*TableInfo
    Views     map[string]*ViewInfo
    Functions map[string]*FunctionInfo
}

type TableInfo struct {
    Name        string
    Schema      string
    Columns     map[string]*ColumnInfo
    PrimaryKeys []string
    Indexes     map[string]*IndexInfo
}
```

...（以降、英語版の内容を日本語で忠実に翻訳・要約して続けてください）
