
# パーサーフロー（ステップ別）

このページはパーサー処理を上流（入力）から下流（実行準備）へ順に整理したものです。
各ステップには対応する内部パッケージ名を併記しています。実装の細部はソースコードを参照してください。

| ステップ名 | 対応パッケージ | 入力 | 出力 | 主な処理内容 | エラー／検証ポイント | 備考 |
|---|---|---:|---|---|---|---|
| 字句解析（Lexer） | `parser/tokenizer` | 生のSQLテンプレート文字列 | トークン列（位置情報付き） | コメント・文字列・数値・識別子・演算子・SnapSQLディレクティブ等をトークン化。位置情報（行/列）を付与。 | 未終端文字列・未終端コメント・未知トークン | 後続のエラー報告に必須の位置情報を提供する。 |
| 基本構文チェック（初期構文検査） | `parser/parserstep1` | トークン列 | 注釈付きトークン列／部分AST | 括弧対、ブロック構造（if/end など）の整合性チェック、ネスト検査。早期の致命的不整合を排除。 | 括弧不一致、ディレクティブ不整合 | 早期エラーで処理停止することで後続処理を簡素化。 |
| SQL文法チェック（句順・基本文法） | `parser/parserstep2` | 注釈付きトークン列 | 概形AST（句構造あり） | SELECT/INSERT/UPDATE/DELETE 等の句構造と句の順序を検証。句内部の基本的整合性を確認。 | 句順エラー、構文構造エラー | 後続の意味解析が求める骨格を確立する。 |
| ディレクティブ／式解析（条件式・変数解析） | `parser/parserstep3` | 概形AST + ディレクティブトークン | 拡張AST（式・ディレクティブノード含む） | テンプレートディレクティブ（if/for 等）の構文解析、式（CEL等）の検証、変数参照形式のチェック。 | 未定義変数、式構文・型エラー | Inspect モードでは一部チェックを緩和することがある。 |
| AST構築（句ノード化） | `parser/parserstep4` | 拡張AST（未整形） | 正式なAST（ノードツリー） | SQL句や要素を明確なノードに変換。カンマ挿入やセンチネルノードの付与、位置情報の整備。 | AST構築失敗、ノード衝突 | AST は以降の最適化・変換の基点となる。 |
| AST最適化／簡約化 | `parser/parserstep5` | AST | 最適化済みAST | 不要ノードの削除、条件式の簡約、ノード結合、定数畳み込み（可能範囲）。 | 最適化による意味変化（回避が必須） | 最適化は意味を変えない前提で行う。 |
| 依存解析（サブクエリ等） | `parser/parserstep7` | 最適化済みAST | 依存情報注釈付きAST | サブクエリ／外部参照の依存関係解析。参照解決や名前衝突の検出。 | 参照解決不能、名前衝突 | 解析失敗でも全体継続可能な設計にする場合が多い。 |
| 中間形式（IR）生成 | `intermediate`（ジェネレータ） | AST | 中間命令列（Instruction） | AST を命令列へ変換。実行時やコード生成に必要な命令・メタ（パラメータ定義、プレースホルダ等）を表現。 | 変換失敗、型不一致 | IR はコードジェネレータと実行エンジンの共通契約となる。 |
| 中間パイプライン処理（Processor群） | `intermediate`（Processors） | 中間命令列 | 注釈・追加命令付き中間命令列 | 複数の Processor により正当性チェック、命令注入、メタ付与を実施。システムカラム注入や暗黙パラメータの登録はここで行う。 | 設定不整合、型不一致、必須情報欠如 | 各 Processor は独立して作用し、順番に実行される。 |
| SystemField の注入（SystemFieldProcessor） | `intermediate`（SystemFieldProcessor） | 注釈付き中間命令列 + 暗黙パラメータ一覧 | コンフィグで定義されたシステムカラムを検出・検証し、必要箇所へ `EMIT` 系命令（システム値注入命令）を注入。パラメータモードに基づく挙動（explicit/implicit/error/none）を決定して暗黙パラメータを登録。 | 設定ミス（モード誤り）、列名衝突、テーブル依存の不備 | AST を直接破壊せず IR に命令を注入する設計を推奨。 |
| コード生成／実行準備 | `codegen` または 実行エンジン | 生成コード または 実行プラン | 中間命令列を元に最終コードまたは実行手続きを生成。暗黙パラメータの供給先（`ctx` 等）を確定し、EMIT系命令の実行時挙動を定義。 | 生成時の型欠落、供給先未定義 | ランタイムの契約（`ctx` からの値取得等）を明確にすること。 |
| 実行時処理 | 実行プラン + 実行時コンテキスト（例: `ctx`） | DB 実行結果 / 副作用 | 実行時に暗黙パラメータを `ctx` 等から取得してクエリへ適用。EMIT 系命令に従いシステム値を注入して実行。DBエラーは分類して上位へ通知／テスト検証に利用。 | 実行時値欠如、DB エラー | DB エラーの正規化（分類）を行い、Expected/Error テストと照合する。


## 共通の注意点

- エラー報告は常に位置情報（行・列）を付ける。上流で補足した文脈情報は下流へ伝搬する。  
- 構文（syntax）と意味（semantic）の責務を明確に分離する。パーサーは構造を保証し、意味的な補完や注入は Processor 群で行う。  
- 中間命令（IR）を改変して情報を注入する設計にすると、コード生成とテスト実行の双方で再利用しやすい。  
- Inspect／検査モードがある場合は、各ステップのチェック厳密度を段階的に切り替える。


## 次の作業候補

- 本文を `system-columns.md` 等の関連ドキュメントへクロスリンクして組み込む。  
- 各ステップに短い入力→出力の具体例を追加して可読性を高める。  
- シーケンス図やフローチャートを追加して視覚化する。

必要ならこのファイルをそのまま既存のドキュメント群へリンク追加・埋め込みします。
