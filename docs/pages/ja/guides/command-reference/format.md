# format コマンド — 使い方（日本語）

## 概要

`snapsql format` は SnapSQL テンプレート／SQL／Markdown（SQL コードブロック）を整形するコマンドです。
テンプレートのインデントやキーワードの大文字化、改行やカンマ位置などを自動で整え、一貫したコードスタイルにします。

- 入力: `.snap.sql` / `.snap.md` / `.sql` / `.md` ファイル（またはディレクトリ、stdin）
- 出力: デフォルトでは指定したファイルを上書き（in-place）。stdin を使う場合は stdout に出力されます。

## 使い方（概要）

基本構文:

# format コマンド — 使い方（日本語）

## 概要

`snapsql format` は SnapSQL テンプレート／SQL／Markdown（SQL コードブロック）を整形するコマンドです。
テンプレートのインデントやキーワードの大文字化、改行やカンマ位置などを自動で整え、一貫したコードスタイルにします。

- 入力: `.snap.sql` / `.snap.md` / `.sql` / `.md` ファイル（またはディレクトリ、stdin）
- 出力: デフォルトでは指定したファイルを上書き（in-place）。stdin を使う場合は stdout に出力されます。

## 使い方（概要）

基本構文:

```sh
snapsql format [flags] <file|directory>
```

主なフラグ:

- `-t`, `--test`
  - 説明: フォーマット結果を標準出力（stdout）に出力します。ファイルの書き換えは行いません（dry-run）。
  - 利用例: 変更内容を確認したいときや CI の検証に便利です。

- `-o <path>`, `--output <path>`
  - 説明: 出力先ファイルを指定します。入力ファイルを上書きせず、指定したファイルに結果を書き込みます。

- `-c`, `--check`
  - 説明: チェックモード。ファイルが現在のフォーマット基準に整っているかを検査し、整っていなければ終了コード 1 を返します（CI 用）。

- `-d`, `--diff`
  - 説明: 差分表示モード。整形による差分を簡易的に表示します（行単位の差分）。

注意: 既定の挙動は「ファイル/ディレクトリを指定した場合はそのファイルを上書きする（in-place）」。stdin の場合は stdout に出力します。

## フラグの優先順（簡易ルール）

- `-t`（stdout 出力）は最優先で、指定されている場合はファイルの上書きを行いません。stdout へ出力します。
- `-c` や `-d` は出力の代替動作として働き、これらと `-t` を組み合わせると期待どおりの動作になります（例: `-t -d` は差分を stdout に表示）。
- `-o` を指定するとそのファイルへ書き込みます。

## フォーマットルール（主なもの）

以下は `snapsql format` が適用する主な整形ルールです:

- キーワードは大文字化します（例: `select` → `SELECT`）。
- 句や句内の列リストは適切に改行してインデントを付けます（4 スペース）。
- 複数行にわたるリストはトレーリングカンマに統一します。
- `AND` / `OR` 演算子は行末に置くスタイルを適用します（行末継続が見やすくなります）。
- SnapSQL のディレクティブ（例: `/*# if */`, `/*# for */`）は新しいインデントレベルを作ります。
- インライン式（例: `/*= expr */`）はそのまま保持しますが、周辺のインデント/改行は整えます。
- Markdown: SQL のコードブロック（```sql）内のみを整形し、他の Markdown 部分は変更しません。

### 具体的な例（注意点）

- 式の意味を壊すような変換（`::` を `CAST()` に置き換える等）は現在のデフォルト整形では行いません。方言依存の変換はジェネレータ側で別途サポート予定です（TODO）。

## 例: コマンド & 挙動

1) ファイルを上書き（デフォルト）

```sh
# input: query.snap.sql を整形して上書き
snapsql format query.snap.sql
```

2) stdout に出力（dry-run）

```sh
# フォーマット結果を表示するのみ（ファイルは変更しない）
snapsql format -t query.snap.sql
```

3) 出力先を指定

```sh
# 整形結果を別ファイルへ出力
snapsql format -o query.formatted.sql query.snap.sql
```

4) チェックモード（CI 向け）

```sh
# 整形済みでなければ exit code 1 を返す
snapsql format -c ./queries/
```

5) ディレクトリを指定（全ファイル上書き）

```sh
# ディレクトリ内の SnapSQL 対象ファイルをすべて上書きする
snapsql format ./queries/
```

## Before / After サンプル

以下は単純化したクエリの例です。左が元の（整形前）、右が `snapsql format` によって整形されたものです。

### 元（整形前）

```sql
select id,name,created_at from accounts where status='active' and (created_at>='2020-01-01' or updated_at is null)
```

### 整形後（`snapsql format`）

#### SQLファイル

```sql
SELECT
    id,
    name,
    created_at
FROM
    accounts
WHERE
    status = 'active'
    AND (
        created_at >= '2020-01-01'
        OR updated_at IS NULL
    )
```

#### Markdown 内の SQL ブロック(ブロック中だけがフォーマットされる)

````md
```sql
SELECT
    *
FROM
    users
WHERE
    id = 1
```
````

## よくある質問 / 注意点

- Q: CI でのチェック方法は？
  - A: `snapsql format -c` を使って、整形されていないファイルがあれば失敗させる方法が一般的です。

## 追加のヒント

- `-t` を利用して差分をレビューし、問題なければそのまま `snapsql format <path>` を実行して上書きするワークフローがおすすめです。
- 大規模リポジトリでは、まず `-t` で変更点を確認し、CI で `-c` を有効化してコミット前チェックを自動化すると安全です。

---

ドキュメント作成: このファイルは `docs/pages/ja/guides/command-reference/format.md` に追加されました。必要なら英語版（`docs/pages/en/...`）への同内容翻訳も作成できます。

主なフラグ:

- `-t`, `--test`
	- 説明: フォーマット結果を標準出力（stdout）に出力します。ファイルの書き換えは行いません（dry-run）。
	- 利用例: 変更内容を確認したいときや CI の検証に便利です。

- `-o <path>`, `--output=<path>`
	- 説明: 出力先ファイルを指定します。入力ファイルを上書きせず、指定したファイルに結果を書き込みます。

- `-c`, `--check`
	- 説明: チェックモード。ファイルが現在のフォーマット基準に整っているかを検査し、整っていなければ終了コード 1 を返します（CI 用）。

- `-d`, `--diff`
	- 説明: 差分表示モード。整形による差分を簡易的に表示します（行単位の差分）。

注意: 既定の挙動は「ファイル/ディレクトリを指定した場合はそのファイルを上書きする（in-place）」。stdin の場合は stdout に出力します。
