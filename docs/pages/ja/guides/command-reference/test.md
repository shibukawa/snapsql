# test コマンド

`snapsql test` はテンプレートに埋め込まれた `## Test Cases` ブロックを実行して、Fixtures / Parameters / Expected Results に基づく受け入れテストを行います。

## 利用例

```bash
# プロジェクト内のすべてのテストを実行（tbls による既存 DB へ接続）
snapsql test

# 指定パターンのテストのみを実行（長い方のフラグ名は --run-pattern）
snapsql test --run-pattern "BoardList"

# tbls 設定ファイルを明示的に指定して既存 DB に接続して行う(デフォルト動作。未設時は.tbls.yamlを探索)
snapsql test --tbls-config ./tbls.yaml

# スキーマを適用してエフェメラル DB（in-memory SQLite）で実行する例
snapsql test --schema ./schema/init.sql
```

## 実行フロー

1. CLI 引数を読み込み、`snapsql.yaml`（設定）をロードします。
2. 実行環境の準備
	- `--schema` が指定されている場合：in-memory SQLite をプロビジョニングし、指定した SQL スキーマを適用してエフェメラル DB を作成します（`runWithSchemaDatabase` 経路）。
	- 指定がない場合：tbls ランタイムから DSN を取得して既存 DB に接続してテストを実行します（`runWithTblsDatabase` 経路）。

3. テストケースごとの実行シーケンス（詳細）

	各テストケースは次の順で実行されます。フローの多くは `fixtureexecutor` と `testrunner` によって実装されています。

	1) トランザクション開始
		- 各テストケース実行は通常トランザクションの中で行われます（デフォルトはロールバック）。
		- `--commit` を指定するとテストケース内のトランザクションはコミットされます。

	2) フィクスチャのロード（バリエーションあり）
		- 標準モード: テストケースで定義された Fixtures をデータベースに挿入します。
		- `--fixture-only` モード: フィクスチャ挿入のみを行い、クエリ実行や検証は行いません（`--run-pattern` の指定が必須）。
		- `--query-only` モード: フィクスチャはロードせず、既存データでクエリのみ実行します。
		- 挿入方法の違い: 単純 INSERT、UPSERT（存在時は更新）、トランザクションを利用したバルク挿入など、フィクスチャごとに挙動が変わる場合があります（fixture の記述や設定に依存）。

	3) パラメータおよび環境の設定
		- テストケースに定義された Parameters をクエリ実行にバインドします。パラメータはファイル（JSON/YAML）や個別 `--param` 指定からの入力とマージされます。
		- 特殊リテラル（例: `current_date` 等）やデータアンカー（固定時刻）を使うケースもあり、これらはテスト実行コンテキストで解決されます。

	4) クエリ実行
		- PreparedSQL（プレースホルダ変換後）を実際に DB に投げて結果を取得します。
		- 実行時には `--timeout` や `ExecutionOptions.Timeout` によりタイムアウト制御が行われます。

	5) Expected Results（期待結果）との比較（バリエーションあり）
		- 完全一致比較: 取得した行の順序・値を厳密に比較するモード。
		- カラム単位 / PK ベース比較: 主キーによるマッチングや、特定カラムのみ比較するなど柔軟な比較戦略が利用可能（設定やテストの記述に依存）。
		- マッチャー/パターン: 正規表現マッチ、部分一致、NULL / 非NULL チェックなど、期待結果側で matcher を指定できる場合があります。
		- 差分レポート: 差分がある場合は差分の要約や失敗時に詳細な比較ログ（期待値 vs 実際）を出力します。

	6) `EXPLAIN` / 実行計画の取得（オプション）
		- テスト実行後、必要に応じて `EXPLAIN`（または `EXPLAIN ANALYZE`）を実行して実行計画を収集します。
		- 実行計画の収集はパフォーマンス評価やクエリ最適化のために行われ、`explain` パッケージで解析・集計されます。

	7) トランザクションのコミット/ロールバック
		- デフォルトではロールバックして DB の状態を元に戻します。
		- `--commit` 指定時や `--fixture-only` の特別なフローではコミットが行われます。

	8) 結果の集計と出力
		- 各テストケースの成否、実行時間、遅延クエリ情報（しきい値超過時）などを集計して報告します。

	注: 具体的な挙動（フィクスチャの挿入方式、期待結果の比較戦略、EXPLAIN の実行タイミングなど）は設定ファイルやテストケース内の記述に依存します。詳細は `testrunner` と `fixtureexecutor` の実装を参照してください。

## フラグ

- `--run-pattern=<パターン>, -r <パターン>` : 実行するテスト名を正規表現で指定します（フィールド名は `RunPattern`）。注: 古いドキュメントの `--run` は実装と一致しません。
- `--timeout <duration>` : テスト全体のタイムアウト（例: `10m`）。デフォルトは `10m`。
- `--parallel <n>` : 並列ワーカー数（デフォルト 0 は CPU コア数）。
- `--fixture-only` : フィクスチャの挿入のみ実行（`--run-pattern` 指定が必須）。
- `--query-only` : フィクスチャをロードせずクエリ実行のみ行う。
- `--commit` : テスト内のトランザクションをコミット（デフォルトは rollback）。
 - `--schema, -s <path>` : エフェメラル DB の初期スキーマとして適用する SQL ファイルまたはディレクトリ（複数回指定可）。

## tbls / 接続に関する挙動

- デフォルトの動作（`--schema` を指定しない場合）は、tbls ランタイムから DSN を取得して既存のデータベースに接続してテストを実行するパスです（`resolveDatabaseFromTbls` を使います）。
- 特定の tbls 設定ファイルを明示的に指定したい場合はグローバルフラグ `--tbls-config=<path>` を使ってください（`main` のグローバル `CLI` に追加済み）。`--config` に `.tbls.yaml` を渡す既存の挙動も互換的に動作します。
- かたや、エフェメラル DB にスキーマを適用してテストしたい場合は `--schema` を指定します。この場合は in-memory SQLite をプロビジョニングしてスキーマを適用した上でテストが実行されます（`runWithSchemaDatabase` の実装）。

詳細: 実行時のフィクスチャ戦略や特殊リテラル等は `docs/pages/ja/guides/query-docs/special-literals.md` と `docs/pages/ja/getting-started/testing.md` を参照してください。
